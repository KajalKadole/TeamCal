<!-- 
Add this Leave Request Modal to your base.html (or create a separate template to include)
This makes it available on ALL pages
File: templates/includes/leave_request_modal.html
-->

<!-- Leave Request Modal - Global Component -->
<div class="modal fade" id="leaveRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-umbrella-beach me-2"></i>On Leave
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Your leave request will be sent to HR for approval. 
                    It will appear on the calendar only after approval.
                </div>
                
                <form id="leaveRequestForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date <span class="text-danger">*</span></label>
                            <input type="date" id="leaveStartDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Date <span class="text-danger">*</span></label>
                            <input type="date" id="leaveEndDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Leave Type <span class="text-danger">*</span></label>
                        <select id="leaveRequestType" class="form-select" required>
                            <option value="">Select leave type</option>
                            <option value="Annual Leave">Annual Leave / Vacation</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Personal Leave">Personal Leave</option>
                            <option value="Casual Leave">Casual Leave</option>
                            <option value="Maternity Leave">Maternity Leave</option>
                            <option value="Paternity Leave">Paternity Leave</option>
                            <option value="Unpaid Leave">Unpaid Leave</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for Leave <span class="text-danger">*</span></label>
                        <textarea id="leaveReason" class="form-control" rows="4" 
                                  placeholder="Please provide a brief reason for your leave request" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Contact During Leave (Optional)</label>
                        <input type="text" id="leaveContact" class="form-control" 
                               placeholder="Phone number or email where you can be reached">
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="mb-2">Leave Summary</h6>
                            <div class="d-flex justify-content-between">
                                <span>Total Days:</span>
                                <strong id="leaveTotalDays">0 days</strong>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitLeaveRequest()">
                    <i class="fas fa-paper-plane me-1"></i>Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Global Leave Request JavaScript -->
<script>
// Global functions for leave request modal - accessible from any page
(function() {
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeLeaveModal();
    });
    
    function initializeLeaveModal() {
        const startDateInput = document.getElementById('leaveStartDate');
        const endDateInput = document.getElementById('leaveEndDate');
        
        if (!startDateInput || !endDateInput) return;
        
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
        endDateInput.min = today;
        
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
            if (endDateInput.value < this.value) {
                endDateInput.value = this.value;
            }
            calculateLeaveDays();
        });
        
        endDateInput.addEventListener('change', calculateLeaveDays);
    }
    
    // Make function global
    window.showLeaveRequestModal = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('leaveStartDate').value = today;
        document.getElementById('leaveEndDate').value = today;
        calculateLeaveDays();
        
        const modal = new bootstrap.Modal(document.getElementById('leaveRequestModal'));
        modal.show();
    };
    
    window.calculateLeaveDays = function() {
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end >= start) {
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('leaveTotalDays').textContent = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('leaveTotalDays').textContent = '0 days';
            }
        }
    };
    
    window.submitLeaveRequest = async function() {
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const leaveType = document.getElementById('leaveRequestType').value;
        const reason = document.getElementById('leaveReason').value;
        const contact = document.getElementById('leaveContact').value;
        
        // Validation
        if (!startDate || !endDate || !leaveType || !reason) {
            alert('Please fill in all required fields');
            return;
        }
        
        if (new Date(endDate) < new Date(startDate)) {
            alert('End date must be after start date');
            return;
        }
        
        try {
            const response = await fetch('/api/leave-requests/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    leave_type: leaveType,
                    reason: reason,
                    contact: contact
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`Leave request submitted successfully!\nTotal Days: ${data.total_days}\n\nYou will receive an email notification once reviewed by HR.`);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('leaveRequestModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('leaveRequestForm').reset();
                
                // Reload page or refresh data based on current page
                if (typeof loadLeaveRequests === 'function') {
                    // On leave_requests page
                    loadLeaveRequests('pending');
                    loadMyLeaveRequests();
                    updateStatistics();
                } else if (typeof calendar !== 'undefined') {
                    // On calendar page
                    calendar.refetchEvents();
                }
                
                // Reload page after 1 second to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error submitting leave request:', error);
            alert('Failed to submit leave request. Please try again.');
        }
    };
})();
</script>